<!DOCTYPE html>
<html>
  <head>
    <title>Spreader</title>
    <style>
      body {
        align-self: stretch;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
      }

      .reader-container {
        background-color: #eee;
        display: flex;
        flex: 1;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }

      .reader-doc {
        color: #000;
        color: transparent;
        font-size: 8px;
        line-height: 1;
        overflow-y:  auto;
        position: relative;
        width: 100%;
      }


      .reader-doc-word .reader-orp {
        color: transparent;
      }

      .reader-doc::-webkit-scrollbar {
        background-color: transparent;
        width: 5px;
      }

      .reader-doc::-webkit-scrollbar-thumb {
        background-color: #aaa;
      }

      .reader-doc-page {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        margin: 200px auto 100px auto;
        padding: 16px;
        width: 300px;
      }

      .reader-doc-paragraph {
        display: flex;
        flex-flow: row wrap;
        margin: 8px;
      }


      .reader-doc-word {
        background-color: #ccc;
        border-radius: 1em;
        margin: 2px;
        padding: 0 4px;
      }

      .reader-doc-paragraph .reader-doc-word:first-child {
        margin-left: 30px;
      }

      .reader-orp {
        color: #f00;
      }

      .reader-read {
        background-color: #333;
      }

      .reader-box {
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        height: 60px;
        position: absolute;
        top: 60px;
        transform: translateY(-50%);
        width: 350px;
      }

      .reader-box::after {
        position: absolute;
        content: '';
        width: 4px;
        height: 100%;
        left: calc(50% - 2px);
        right: 0;
        background: linear-gradient(#ddd, #fff 30%, #fff 70%, #ddd);
        z-index: -1;
      }

      .reader-box-container {
        position: relative;
      }

      .reader-box-msg {
        font-size: 30px;
        position: absolute;
        top: 30px;
        transform: translateY(-50%);
      }

      .reader-box-pointer {
        color: #f00;
        position: absolute;
        text-align: center;
        top: 170px;
        transform: translate(-50%, -1em);
        transition: left .1s ease, top .1s ease;
      }
    </style>
  </head>
  <body>
    <script>
      var potter = `Book 42, The Five Truncheon Chapters, Chapter 10 – Utterly Exhausted
The white-robed Ji Ning was continuing to dodge and retreat in midair, while the Flameland Elder Hall was continuing to launch frenzied attacks against him.
Rumble…
The Flameland Elder Hall launched attack after attack, using those massive streams of golden fire, the enormous fans of saber-light, and those giant dimensional waves. On top of these wide-ranging area attacks, they also launched quite a number of single-target attacks against Ning! These single-target attacks were more focused, and as a result they were more powerful!
“We’ve already launched a total of fifteen wide-range attacks, and also launched nineteen waves of attacks with our other formations. How is he still able to keep fighting?” The Hegemons within the Flameland Elder Hall who were in control of the formations were beginning to grow anxious.
“His truesoul is collapsing even more quickly now. He’ll probably be dying soon.”
“He’s so powerful that he far surpasses any other Daolord. His truesoul is probably much stronger as well, allowing him to stay alive for a longer period of time.”
“Let’s give him another blast.”
“He’ll die any moment now.” Under Hawkfang’s direction, the Hegemons and Emperors in the Flameland Elder Hall launched yet another furious wave attacks, while Ning continued to retreat while blocking as best he could.
Time continued to tick away. Hawkfang watched as the rate at which Ning’s truesoul crumbled away continued to increase. He was clearly in increasingly bad shape. Any ordinary Daolord would’ve died long ago! Ning, however, was able to somehow keep fighting.
More time passed. Ning continued to run around the area, blocking and defending. He looked as though he was in his death throes… but he simply wouldn’t die! By now, the Fireland Elder Hall had used up the majority of its energy stores.
“It’s all an illusion!” Hawkfang suddenly said coldly, a frozen look on his face.
“An illusion?” The avatars of the Emperors next to him were all stunned. As the battle had raged on for longer than they had expected, they too had started to grow increasingly uneasy, but they could tell that the white-robed Daolord’s truesoul really was crumbling away faster and faster. It looked as though they were very close to succeeding in their task of slaying this ‘Daolord Darknorth’. They really didn’t want to believe it was all an illusion.
Hawkfang gritted his teeth. “He was already at death’s door before we even started! By now, the Flameland Elder Hall has used up more than half of our energy stores, yet he is somehow still able to keep up the fight? He’s just a Daolord! How strong could his truesoul possibly be?”
“Then w-we…” the Hegemons and Emperors all started to panic.
……
“So it really is an illusion.” Exalt Bowenya watched from afar. “He is the first Daolord to master an Eternal Omega Dao in this Chaosverse. He truly cannot be underestimated! Still… while I knew his sword-arts were powerful, I never would’ve imagined that his illusions would be so incredible as well. Even I cannot see any flaws in his illusions.”
Exalt Bowenya remained quite calm. He had been alive for a very long time, and the Sithe Chaosverse was a far more advanced place than this one. Back in his homeland, there had been quite a few who had become Eternal Emperors via an Omega Dao! Thus, Exalt Bowenya was able to accurately judge Ning’s power and abilities. However, he felt that since Ning was a Daolord who had failed the Daomerge, by all rights he should’ve been lacking in areas aside from his primary Dao, as he simply hadn’t been alive long enough. Now, it seemed, Daolord Darknorth had reached incredible heights in the art of illusions.
“Then what should I do, Exalt?” Jonnbech frowned.
“Follow our original plan,” Exalt Bowenya said. “I’ll give you every treasure I can spare! There’s no way Hawkfang can win this fight. His Flameland Elder Hall will run out of energy soon, and once it does it won’t even be able to continue flying! This battle will be up to you.”
“Understood.” Jonnbech nodded.
“What a pity.” Exalt Bowenya stared off into the distance. “We have had innumerable progeny, but Hawkfang was quite arguably the most talented one to have ever arisen within this Chaosverse. He had a good chance of becoming an Autarch! If he succeeded, his status would’ve skyrocketed to a level that was much higher than my own. Unfortunately, his Dao-heart was flawed and he has never been able to perfect it.”
To become an Autarch, one needed a perfect Dao-heart. The same was needed to master an Eternal Omega Dao.
“He’ll probably die here.” Exalt Bowenya let out a sigh. Once the power of the Flameland Elder Hall was used up, it would no longer pose a threat to Daolord Darknorth at all, who would be able to capture Hawkfang with ease. Not even Exalt Bowenya would dare to battle Ning head-on without the backing of his Daoguard Tower.
……
Within the Sword Dao Domain. A glowing castle that was merely thirty meters long was stationed here, with Ning and Azurefiend’s avatar located within it. Azurefiend’s avatar was pouring Immortal energy into the castle, keeping it active. As for Ning, he was seated off to one side in front of a table that had a flask of wine and a wine cup on it. Every so often, he would lift up the wine cup and take a sip.
He only needed to spare a bit of attention to maintaining the illusions within the Sword Dao Doman, making the illusory Ning’s performance more convincing! The single-target attacks were powerful and concentrated, with the ones shooting out from this Exalt-class Daoguard Tower being close to Autarch-level attacks in might. However, they all hit the illusory Ning without harming the real one in the slightest.
As for the large-scale attacks, they dispersed their might across an extremely wide area, making it fairly easy to defend against them. However, Ning wasn’t willing to do so and instead took out a Sithe treasure.
It must be remembered that Ning had captured over 2,800 Hegemons and Emperors during the previous battle! They had carried many types of treasures on them, and it could be said that they collectively held roughly over 80% of the total Sithe treasures within this hidden dimension. Now, those treasures were all Ning’s! There were actually over ten items that were on the level of the Blacksun. Ning had pulled out one of them and allowed Azurefiend’s avatar to bind it, then used it to defend against the attacks.
Ning had selected this castle for its sturdiness and defensive strength. It was able to defend against the large-scale attacks that struck it with ease. This castle was on the same level as the Blacksun, and it was specialized in defense. Attacks like this, merely on par with the Blazesun Ruler, were completely unable to breach its thick walls. The only thing they did was to consume Azurefiend’s power.
“Withdraw.” Ning watched the battle proceed while causing his Sword Dao Domain to rapidly retreat and disperse.
“Master, why are you having us retreat?” Azurefiend’s avatar asked. “These Sithe have extremely powerful attacks, but the wide-scale ones are all being blocked by the castle. Why should we withdraw?”
“That’s where you are wrong.” Ning laughed. “Warfare isn’t as simple as attacking and defending. You need to see beyond the clashes to the nature of the battle itself. There’s no need for us to do too much in this battle against the Flameland Elder Hall. Given enough time, they will run out of energy and we will have won.”
Ning’s gaze went through the walls of the castle, allowing him to see the Flameland Elder Hall which continued to pursue and assault them. “Once they broke free from their foundations, they no longer had any chance to retreat. Their only option was to unleash all the power available to them in a final, desperate assault,” Ning explained. “So… why should we actually fight them? I’ll just keep running, while they will keep chasing. It actually takes this Daoguard Tower energy to fly through the air as well.”
There was another unspoken reason why Ning had them continuously retreat. This was because he wanted to stay as far away from the other two Elder Halls as possible! That way, once he captured all the Hegemons and Emperors in the Flameland Elder Hall, he would be able to review their memories without being disturbed. If he was too close to the other two Elder Halls, they’d probably launch attacks at him and disrupt him. If he stayed farther away, it would be harder for them to bother him.
……
Explosions of ruinous power continued to ring out unabated, with Ning continuing to fight while fleeing. Every so often, a streak of Autarch-level golden light would shoot out, tearing through the earth and gouging unfathomably deep tunnels in the ground. As for the wide-scale attacks that covered as much as ten billion kilometers, they would terrify even most Hegemons.
Any other cultivator would’ve perished long ago from a battle like this. Only the Autarchs and Ning were equipped to handle it.
“The Flameland Elder Hall has nearly been utterly exhausted of all its power. It only has enough to keep flying.” Hawkfang gritted his teeth after saying these words. His voice echoed throughout the entire Elder Hall, with every single Emperor and Hegemon inside hearing them. “We have lost this battle. The only thing we have left is a final charge.”
Hawkfang felt pain and sorrow in his heart, because he knew that this final charge would result in his comrades throwing their lives away. The cultivators… the Sithe… Hawkfang wasn’t sure who he truly belonged to, but he knew that the people he cared the most about were his comrades, the other Sithe descendants. And yet, his care alone wouldn’t be of any use. He couldn’t disobey Exalt Bowenya’s orders. Every single Hegemon and Emperor had long ago sworn oaths to obey Exalt Bowenya.
“The final charge.”
“Attack! Even as we die, let’s use up more of Daolord Darknorth’s power. Exhaust him!”
“Kill him, and we’ll bring hope to our homeland. Once we die, it’ll all be for nothing.”
“Kill!”
“Hawkfang, you stay back. So long as you are alive, the others will still have a leader!” The Hegemons and Emperors began to charge out of the Flameland Elder Hall, moving like streaks of light towards Ning as they tried to dissuade Hawkfang from joining the battle.`;

      const SIMILAR_RATIO = 1/8;
      const $ = document.querySelector.bind(document);

      // Calculate the optimal recognition point of a word
      function optimalRecognitionPoint(word) {
        let length = word.length;
        while('\n,.?!:;"'.indexOf(word[--length]) !== -1);
        switch(++length) {
          case 0: case 1: return 0;
          case 2: case 3: return 1;
          default: return Math.floor(length / 2 - length / 6);
        }
      }

      // Return the number of time arr appears in a string
      function strNumInstances(str, arr) {
        return arr
          .map(x => (str.match(new RegExp(x, 'g')) || []).length) // count instances
          .reduce((a, b) => a+b); // Sum instances
      }

      function wordSimilarCharRatio(word) {
        // Characters that look similar
        let offenders = [
          ['m', 'rn', 'n'],
          ['cl', 'ci', 'd'],
          ['vv', 'w', 'uu,'],
          ['u', 'v'],
          ['l', 'i'],
          ['i', 'j'],
          ['j', 'l,'],
          ['h', 'k'],
          ['p', 'q', 'b', 'd'],
          ['s', 'z'],
          ['t', 'f'],
          ['O', 'Q'],
          ['L', 'J'],
          ['E', 'F'],
          ['S', 'Z'],
          ['B', 'P'],
        ];

        let numOffenders = offenders
          .map(off => strNumInstances(word, off)) // Count number of each offender
          .reduce((a, b) => a+b); // Sum them

        return 1 - Math.min(numOffenders, 10) / 10 * SIMILAR_RATIO;
      }

      // Read words of length 4-7 faster than 0.9
      function wordLengthRatio(word) {
        return word.length < 4 || word.length > 7 ? 1 : 0.97;
      }

      // Word speed ratio based on punctuation
      function wordPunctuationRatio(word) {
        let lastChar = word.slice(-1);
        // How much slower a word should be based on each punctuation mark
        let punctuationRatios = {
          '.': 0.4,
          '?': 0.5,
          '!': 0.5,
          ',': 0.5,
          ';': 0.6,
          ':': 0.6,
        };
        return punctuationRatios[lastChar] || 1;
      }

      // Calculates the word speed ratio of a word
      function wordSpeedRatio(word) {
        return wordLengthRatio(word) * wordPunctuationRatio(word) * wordSimilarCharRatio(word);
      }

      // Creates an XSS safe element given a tag name, props, and its content
      function makeElem(tag, props, ...content) {        
        let s = document.createElement(tag);

        // Content is a string
        if(content.length === 1 && typeof content[0] === 'string') {
          s.innerText = content[0];

        // Content is an array
        } else {
          content.forEach(elem => elem && s.appendChild(elem));
        }

        // Add all the props to the span
        for(let key in props) {
          s.setAttribute(key, props[key]);
        }

        return s;
      }

      // Creates a span for a word and splits it based on its ORP
      function orpSpan(word) {
        let orp = optimalRecognitionPoint(word);
        return makeElem('span', {class: 'reader-word'},
          makeElem('span', {}, word.slice(0, orp)),
          makeElem('span', {class: 'reader-orp'}, word[orp]),
          makeElem('span', {}, word.slice(orp+1)),
        );
      }

      // Takes some text, splits it up into word objects
      function parseText(text) {
        let words = text
          .split(/\s+|\n/g)
          .map(w => ({
            word: w,
            ratio: wordSpeedRatio(w),
            orp: optimalRecognitionPoint(w),
            html: orpSpan(w),
          }));
        return words;
      }

      // Destination scroll position of document
      let goalDocScroll = 0;

      // identifier for requested animation frame
      let frameReq;

      // Animated smooth scrolling
      function scrollToPos() {
        const doc = $('.reader-doc');
        doc.scrollTop += (goalDocScroll - doc.scrollTop) * 0.2;
        if(Math.abs(doc.scrollTop - goalDocScroll) < 1) {
          doc.scrollTop = goalDocScroll;
          frameReq = undefined;
          return;
        }
        frameReq = requestAnimationFrame(scrollToPos);
      }

      // Moves the pointer to the specified elem
      function movePointer(word) {
        const pointer = $('#readerPointer');
        const doc = $('.reader-doc');
        const box = $('.reader-box');
        const msg = $('.reader-box-msg');
        /*
          Aligning the pointer
        */
        let {x, y, width, height} = word.elem.getElementsByClassName('reader-orp')[0].getBoundingClientRect();
        let {x: offX, y: offY, height: docHeight} = doc.getBoundingClientRect();
        let {top: top, height: pageHeight} = $('.reader-doc-page').getBoundingClientRect();
        let {y: pointerY, height: pointerHeight} = pointer.getBoundingClientRect();

        if(!word.elem.className.match(/reader-read/))
          word.elem.className += ' reader-read';

        // Calculate y position of pointer
        if(document.body.clientHeight >= doc.scrollHeight || doc.scrollHeight <= doc.scrollTop + docHeight) {
          pointer.style.top = (y + offY + height/2 + pointerHeight) + 'px';
        } else {
          pointer.style.top = '30px';
          goalDocScroll = doc.scrollTop + y - pointerY + height / 2 + offY;
          if(frameReq)
            cancelAnimationFrame(frameReq);
          frameReq = requestAnimationFrame(scrollToPos);
        }

        // calculate x position of pointer
        pointer.style.left = (x - offX + width/2) + 'px';

        /*
          Updating the word box
        */
        msg.removeChild($('.reader-box-msg').firstChild);
        msg.appendChild(word.html);
        // Reset msg position
        msg.style.left = '0px';

        // Get position of the orp in the word
        let {x: orpX, width: orpWidth} = word.html.getElementsByClassName('reader-orp')[0].getBoundingClientRect();
        let {x: msgX, width: msgWidth} = $('.reader-box-container').getBoundingClientRect();

        // Set the msg x offset to the center of the orp
        msg.style.left = (msgX - orpX - orpWidth / 2 + msgWidth / 2) + 'px';
      }

      let reader;

      // Creates the speedreader dom
      function createSpeedReader(text) {
        let paragraphs = text.map(parseText);
        let i = 0;
        let paragraphIndex = 0;
        let container = makeElem('div', {class: 'reader-container'}, 
          makeElem('div', {class: 'reader-doc'},
            makeElem('div', {class: 'reader-doc-page'},
              ...paragraphs.map((words, p) =>
                makeElem('div', {class: 'reader-doc-paragraph'},
                  ...words.map(w => {
                    const index = i;
                    w.index = i++;
                    w.paragraph = p;
                    w.elem = makeElem('span', {class: 'reader-doc-word'}, orpSpan(w.word));
                    w.elem.addEventListener('click', () => {movePointer(w); reader.index = index;}, false);
                    return w.elem;
                  }),
                ),
              ),
            ),
          ),
          makeElem('div', {class: 'reader-box-pointer', id: 'readerPointer'}, String.fromCharCode(9650)),
          makeElem('div', {class: 'reader-box'},
            makeElem('span', {class: 'reader-box-container'},
              makeElem('span', {class: 'reader-box-msg'}, 'Press Right Arrow Key!'),
            )
          ),
        );
        let words = [].concat(...paragraphs);
        return {
          container,
          words,
          length: words.length,
          index: 0,
        };
      }
      reader = createSpeedReader([potter, potter, potter]);
      document.body.appendChild(reader.container);
      movePointer(reader.words[0]);
      const wpm = 500;
      let charTimeout;
      let keys = {};
      let dir = 1;
      let lastIndex = 0;

      function nextWord() {
        clearTimeout(charTimeout);
        let word = reader.words[reader.index];
        movePointer(word);
        reader.index = Math.max(Math.min(reader.index + dir, reader.length-1), 0);
        charTimeout = setTimeout(nextWord, 60000 / wpm / word.ratio);
      }

      window.addEventListener('keydown', e => {
        let {code} = e;
        if(keys[code])
          return;

        keys[code] = true;
        switch(code) {
          case 'ArrowLeft':
            dir = -1;
            lastIndex = reader.index;
            break;
          case 'ArrowRight':
            lastIndex = reader.index;
            dir = 1;
            break;
        }
        if(dir !== 0) {
          nextWord();
        }
      }, false);
      window.addEventListener('keyup', e => {
        let {code} = e;
        keys[code] = false;

        switch(code) {
          case 'ArrowLeft':
            if(keys.ArrowRight) {
              dir = 1;
            } else {
              if(reader.index === lastIndex + dir)
                nextWord();
              reader.index = Math.max(Math.min(reader.index - dir, reader.length), 0);
              dir = 0;
            }
            break;
          case 'ArrowRight':
            if(keys.ArrowLeft) {
              dir = -1;
            } else {
              if(reader.index === lastIndex + dir)
                nextWord();
              reader.index = Math.max(Math.min(reader.index - dir, reader.length), 0);
              dir = 0;
            }
            break;
        }
        if(dir === 0) {
          clearTimeout(charTimeout);
        }
      }, false);
    </script>
  </body>
</html>
